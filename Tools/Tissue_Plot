import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sb
import os

os.chdir(r"C:\Users\15154\Desktop\RIA")

#Read in metadata
metadata=pd.read_csv("metadata",sep="\t")
#Read in results
results=pd.read_csv("SuperpopulationChrAll.PC20SVMResults",sep="\t")

results=results.rename(columns = {'ID':'run_accession'})

#Merge on run_accession
merged=pd.merge(metadata,results,on=['run_accession'])

#This column will be used to get sample size later
merged['sample size']=1

#adds 1 if ancestry inference accurate, 0 otherwise 
def test(s):
    if ((s['Superpopulation'] == s['Eth1']) | (s['Superpopulation'] == s['Eth2'])):
        return 1
    else:
        return 0
                                         
merged['Accuracy'] = merged.apply(test, axis=1)                                     
merged['TissueGroup']=merged['Population'] + "#" + merged['Tissue']
                     

#Sum sample size and Accuracy
merged = merged.groupby(['TissueGroup'],as_index = False).sum()
#Calulate overall accuracy
merged['OverallAccuracy']=merged['Accuracy']/merged['sample size']*100



#Split TissueGroup column into 2
merged[['Study','Tissue']] = merged.TissueGroup.str.split("#",expand=True)




plot=sb.barplot(x='Study', y='OverallAccuracy', hue="Tissue", data=merged)
plot.set_xticklabels(plot.get_xticklabels(), rotation=90,size = 7)  

plot2=sb.barplot()

print(type(plot))
for patch in plot.patches:
    # we change the bar width
    if patch.get_height() > 0: 
        patch.set_width(0.3)
        #plot2.add_patch(patch)

print(plot2)

plt.legend(bbox_to_anchor=(1.01, 1),borderaxespad=0)
plt.xlabel("Study")
plt.ylabel("Accuracy")
plt.title("Ancestry Inference Accuracy by Tissue")
#Keeps stuff being cropped


plt.savefig("output.png",format='png',dpi=150,bbox_inches='tight')
