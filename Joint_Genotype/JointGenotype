import os

#Create output directory
DIR='output'
#os.mkdir("temp")
#os.mkdir("JointDatabase")
#Set path to human genome


chr_list = list(range(1, 23))
chr_list.append("X")


#Read in run accession IDs from txt file. 
with open ("RAids.txt") as f:
    ra=f.read().splitlines()

wildcard_constraints:
    chr= '|'.join([str(x) for x in chr_list]),
     	



rule all:
	input: expand(directory("JointDatabase/chr{chr}_database").format(chr=c) for c in chr_list)  
    

rule JointGenotype:
    input: ["{wd}/{sample}/vcf.gz".format(wd=DIR,sample=s) for s in ra]
    output: directory("JointDatabase/chr{chr}_database")
    
    shell:
        """  
        gatk --java-options "-Xmx100g -Xms100g" \
          GenomicsDBImport \
        --genomicsdb-workspace-path JointDatabase/chr{wildcards.chr}_database \
        --batch-size 90 \
     	-L {wildcards.chr} \
        --sample-name-map data/cohort.sample_map \
        --tmp-dir temp \
        --reader-threads 50
        """
        
        
        
        

        
        gatk --java-options "-Xmx200g" GenotypeGVCFs \
        -R /ocean/projects/mcb200036p/jahaltom/Ancestry/data/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna \
        -V gendb://joint/chr{wildcards.chr}_database \
        -O joint/chr{wildcards.chr}.joint.vcf.gz \
        -L {wildcards.chr} \
        --include-non-variant-sites \
        --tmp-dir temp 
        rm -r joint/chr{wildcards.chr}_database
                
        gatk --java-options "-Xmx100g" VariantFiltration \
        -R /ocean/projects/mcb200036p/jahaltom/Ancestry/data/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna \
        -V joint/chr{wildcards.chr}.joint.vcf.gz \
        -O joint/filtered.chr{wildcards.chr}.joint.vcf.gz \
        --filter-expression "DP < 10.0" \
        --filter-name "filter_DP" \
        --filter-expression "MQ < 40.0" \
        --filter-name "filter_MQ" \
        --filter-expression "FS > 60.0" \
        --filter-name "filter_FS" \
        --filter-expression "MQRankSum < -12.5" \
        --filter-name "filter_MQRankSum" \
        --filter-expression "ReadPosRankSum < -8.0" \
        --filter-name "filter_ReadPosRankSum" \
        --filter-expression "QD < 2.0" \
        --filter-name "filter_QD"
        rm joint/chr{wildcards.chr}.joint.vcf.gz*
        
        
        gatk --java-options "-Xmx100g" SelectVariants \
        -R /ocean/projects/mcb200036p/jahaltom/Ancestry/data/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna \
        -V joint/filtered.chr{wildcards.chr}.joint.vcf.gz \
        -O joint/SNP_filtered.chr{wildcards.chr}.joint.vcf.gz \
        --exclude-filtered true \
        --select-type-to-exclude INDEL      
        
        rm joint/filtered.chr{wildcards.chr}.joint.vcf.gz*
     
        for file in joint/SNP_filtered.chr{wildcards.chr}.joint.vcf.gz; do
          for sample in `bcftools query -l $file`; do
            bcftools view -Oz -s $sample -o $sample.{wildcards.chr}.vcf.gz $file
          done
        done
        rm joint/SNP_filtered.chr{wildcards.chr}.joint.vcf.gz*
                    
        """
        

            


	
